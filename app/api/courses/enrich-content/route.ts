import { NextResponse } from 'next/server'
import { prisma } from '@/lib/db'

const enrichedCourseData = [
  {
    slug: 'bezopasnye-metody-rabot-povyshennoy-opasnosti',
    fullDescription: `
      <div>
        <h3>Описание программы</h3>
        <p>Программа обучения разработана в соответствии с требованиями Трудового кодекса РФ, Правил обучения по охране труда и проверки знания требований охраны труда (Постановление Правительства РФ № 2464 от 24.12.2021).</p>
        
        <h3>Цели обучения</h3>
        <ul>
          <li>Изучение нормативных требований охраны труда</li>
          <li>Освоение безопасных методов выполнения работ повышенной опасности</li>
          <li>Формирование компетенций по предотвращению несчастных случаев</li>
          <li>Получение практических навыков применения СИЗ</li>
        </ul>

        <h3>Актуальность</h3>
        <p>Работы повышенной опасности требуют специальной подготовки работников. Обучение обязательно для всех категорий персонала, выполняющих такие работы согласно ст. 214 ТК РФ.</p>
      </div>
    `,
    features: [
      'Обучение по утвержденным программам',
      'Практические занятия на полигоне',
      'Методические материалы',
      'Сертификат государственного образца',
      'Консультации экспертов',
      'Доступ к обновлениям законодательства'
    ],
    requirements: [
      'Среднее профессиональное образование',
      'Опыт работы в области охраны труда',
      'Медицинская справка',
      'Документы об образовании'
    ],
    outcomes: [
      'Знание требований охраны труда при работах повышенной опасности',
      'Умение применять безопасные методы работы',
      'Навыки использования средств индивидуальной защиты',
      'Способность проводить оценку рисков',
      'Компетенции по предотвращению несчастных случаев'
    ]
  },
  {
    slug: 'programma-v-bezopasnye-metody-vrednye-faktory',
    fullDescription: `
      <div>
        <h3>О программе "В"</h3>
        <p>Программа "В" предназначена для обучения работников безопасным методам и приемам выполнения работ при воздействии вр��дных и (или) опасных производственных факторов.</p>
        
        <h3>Содержание обучения</h3>
        <ul>
          <li>Идентификация опасных и вредных производственных факторов</li>
          <li>Методы контроля и измерения факторов рабочей среды</li>
          <li>Коллективные и индивидуальные средства защиты</li>
          <li>Порядок действий в аварийных ситуациях</li>
        </ul>

        <h3>Правовые основы</h3>
        <p>Обучение проводится в соответствии с Правилами обучения по охране труда и проверки знания требований охраны труда, утвержденными Постановлением Правительства РФ № 2464.</p>
      </div>
    `,
    features: [
      'Анализ результатов СОУТ',
      'Изучение профессиональных рисков',
      'Практическая работа с измерительными приборами',
      'Обучение оказанию первой помощи',
      'Удостоверение установленного образца',
      'Методические пособия'
    ],
    requirements: [
      'Прохождение вводного инструктажа',
      'Ознакомление с рабочим местом',
      'Медицинский осмотр (при необходимости)',
      'Документы, удостоверяющие личность'
    ],
    outcomes: [
      'Умение выявлять опасные и вредные факторы',
      'Навыки применения средств защиты',
      'Знание порядка действий в аварийных ситуациях',
      'Способность оценивать профессиональные риски',
      'Навыки оказания первой помощи'
    ]
  },
  {
    slug: 'programma-b-bezopasnye-metody',
    fullDescription: `
      <div>
        <h3>Программа "Б" - базовые знания</h3>
        <p>Базовая программа обучения безопасным методам и приемам выполнения работ, предназначенная для всех категорий работников.</p>
        
        <h3>Ключевые разделы</h3>
        <ul>
          <li>Основы законодательства об охране труда</li>
          <li>Организация системы управления охраной труда</li>
          <li>Обеспечение безопасных условий труда</li>
          <li>Социальная защита пострадавших на производстве</li>
        </ul>

        <h3>Формат обучения</h3>
        <p>Обучение проводится в очном формате с использованием интерактивных методов, кейсов и практических упражнений.</p>
      </div>
    `,
    features: [
      'Базовый курс охраны труда',
      'Интерактивные методы обучения',
      'Решение практических кейсов',
      'Итоговая аттестация',
      'Удостоверение о проверке знаний',
      'Справочные материалы'
    ],
    requirements: [
      'Достижение 18-летнего возраста',
      'Трудовой договор или направление от работодателя',
      'Паспорт или ��ной документ, удостоверяющий личность'
    ],
    outcomes: [
      'Знание основ трудового законодательства',
      'Понимание прав и обязанностей в области охраны труда',
      'Навыки безопасного выполнения работ',
      'Умение применять средства индивидуальной защиты',
      'Знание порядка расследования несчастных случаев'
    ]
  },
  {
    slug: 'vneplanovoe-obuchenie-ohrana-truda',
    fullDescription: `
      <div>
        <h3>Внеплановое обучение</h3>
        <p>Внеплановое обучение проводится при изменении нормативных требований охраны труда, касающихся выполняемых работниками работ, или при несчастных случаях и авариях.</p>
        
        <h3>Основания для проведения</h3>
        <ul>
          <li>Вступление в силу новых или изменение действующих НПА</li>
          <li>Ввод в эксплуатацию нового оборудова��ия</li>
          <li>Происшествие аварии или несчастного случая</li>
          <li>Нарушения требований охраны труда</li>
        </ul>

        <h3>Срочность</h3>
        <p>Внеплановое обучение должно быть проведено в сроки, установленные работодателем, но не позднее 60 календарных дней после наступления оснований.</p>
      </div>
    `,
    features: [
      'Оперативное обучение',
      'Актуальные изменения в законодательстве',
      'Анализ происшествий',
      'Разбор типовых нарушений',
      'Экстренная проверка знаний',
      'Документооборот по результатам'
    ],
    requirements: [
      'Направление от работодателя',
      'Документы о ранее пройденном обучении',
      'Справка о происшествии (при необходимости)'
    ],
    outcomes: [
      'Актуальные знания требований охраны труда',
      'Понимание изменений в законодательстве',
      'Навыки предотвращения повторения инцидентов',
      'Обновленные компетенции по безопасности'
    ]
  },
  {
    slug: 'instruktor-po-ohrane-truda',
    fullDescription: `
      <div>
        <h3>Подготовка инструкторов</h3>
        <p>Программа подготовки инструкторов по охране труда направлена на формирование компетенций для проведения обучения и инструктажей по охране труда.</p>
        
        <h3>Программа включает</h3>
        <ul>
          <li>Методика проведения инструктажей</li>
          <li>Педагогические основы обучения взрослых</li>
          <li>Современные технологии обучения</li>
          <li>Оценка эффективности обучения</li>
        </ul>

        <h3>Практическая часть</h3>
        <p>Обучающиеся проводят пробные инструктажи и получают обратную связь от опытных преподавате��ей.</p>
      </div>
    `,
    features: [
      'Методическая подготовка',
      'Практические занятия',
      'Современные технологии обучения',
      'Сертификат инструктора',
      'Методические материалы',
      'Поддержка после обучения'
    ],
    requirements: [
      'Высшее или среднее профессиональное образование',
      'Опыт работы в области охраны труда не менее 3 лет',
      'Действующее удостоверение по охране труда',
      'Медицинская справка'
    ],
    outcomes: [
      'Компетенции проведения инструктажей',
      'Навыки методической работы',
      'Умение применять современные технологии обучения',
      'Способность оценивать эффективность обучения',
      'Квалификация инструктора по охране труда'
    ]
  }
]

export async function POST() {
  try {
    console.log('Starting course content enrichment...')
    
    let updatedCount = 0
    
    for (const courseData of enrichedCourseData) {
      console.log(`Updating course: ${courseData.slug}`)
      
      const updated = await prisma.course.updateMany({
        where: { slug: courseData.slug },
        data: {
          fullDescription: courseData.fullDescription,
          features: courseData.features,
          requirements: courseData.requirements,
          outcomes: courseData.outcomes
        }
      })
      
      if (updated.count > 0) {
        updatedCount++
        console.log(`Successfully updated: ${courseData.slug}`)
      } else {
        console.log(`Course not found: ${courseData.slug}`)
      }
    }
    
    console.log(`Content enrichment completed. Updated ${updatedCount} courses.`)

    return NextResponse.json({
      message: `Успешно обновлено ${updatedCount} курсов с детальным контентом`,
      updatedCount
    })

  } catch (error) {
    console.error('Error enriching course content:', error)
    console.error('Error details:', error instanceof Error ? error.message : String(error))
    
    return NextResponse.json(
      { 
        error: 'Ошибка при обогащении контента курсов',
        details: error instanceof Error ? error.message : String(error)
      },
      { status: 500 }
    )
  }
}
